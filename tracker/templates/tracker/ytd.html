{% extends "tracker/base.html" %}
{% load static %}
{% load humanize %}
{% load number_formatting %}

{% block title %}Year-to-Date Tracker{% endblock %}

{% block content %}
  <div class="section-header">
    <h2>Year-to-Date Spending Overview</h2>
  </div>

  <div class="charts-row">
    <div class="chart-card">
      <h5>Monthly Net</h5>
      <canvas id="savingsChart"></canvas>
    </div>
    <div class="chart-card">
      <h5>YTD Spend by Category</h5>
      <canvas id="categoryPieChart"></canvas>
    </div>
  </div>

  <div class="table-wrapper">
    <table class="data-table ytd-table">
      <thead>
        <tr>
          <th>Category</th>
          <th>Total Spent</th>
          <th>Annual Budget</th>
          <th>Avg per Month</th>
          <th>Monthly Budget</th>
          <th>Avg Surplus/Deficit</th>
          <th>Total Surplus/Deficit</th>
        </tr>
      </thead>
      <tbody>
        {% for entry in ytd_data %}
          <tr {% if entry.category__id %}class="clickable-row" data-href="/category_year/?category={{ entry.category__id }}&year={{ year }}"{% endif %}>
            <td>{{ entry.category__name }}</td>
            <td>{{ entry.total|dollar_format }}</td>
            <td>{{ entry.annual_budget|dollar_format }}</td>
            <td>{{ entry.avg_per_month|dollar_format }}</td>
            <td>{{ entry.budget|dollar_format }}</td>
            <td class="{% if entry.avg_surplus < 0 %}text-negative{% else %}text-positive{% endif %}">
              {{ entry.avg_surplus|dollar_format }}
            </td>
            <td class="{% if entry.total_surplus < 0 %}text-negative{% else %}text-positive{% endif %}">
              {{ entry.total_surplus|dollar_format }}
            </td>
          </tr>
        {% endfor %}
        <tr class="summary-row">
          <td>{{ total_data.category__name }}</td>
          <td>{{ total_data.total|dollar_format }}</td>
          <td>{{ total_data.annual_budget|dollar_format }}</td>
          <td>{{ total_data.avg_per_month|dollar_format }}</td>
          <td>{{ total_data.budget|dollar_format }}</td>
          <td class="{% if total_data.avg_surplus < 0 %}text-negative{% else %}text-positive{% endif %}">
            {{ total_data.avg_surplus|dollar_format }}
          </td>
          <td class="{% if total_data.total_surplus < 0 %}text-negative{% else %}text-positive{% endif %}">
            {{ total_data.total_surplus|dollar_format }}
          </td>
        </tr>
        <tr class="clickable-row" data-href="/category_year/?category={{ income_data.category__id }}&year={{ year }}">
          <td>{{ income_data.category__name }}</td>
          <td>{{ income_data.total|dollar_format }}</td>
          <td>{{ income_data.annual_budget|dollar_format }}</td>
          <td>{{ income_data.avg_per_month|dollar_format }}</td>
          <td>{{ income_data.budget|dollar_format }}</td>
          <td class="{% if income_data.avg_surplus < 0 %}text-negative{% else %}text-positive{% endif %}">
            {{ income_data.avg_surplus|dollar_format }}
          </td>
          <td class="{% if income_data.total_surplus < 0 %}text-negative{% else %}text-positive{% endif %}">
            {{ income_data.total_surplus|dollar_format }}
          </td>
        </tr>
        <tr>
          <td>{{ savings_data.category__name }}</td>
          <td>{{ savings_data.total|dollar_format }}</td>
          <td>{{ savings_data.annual_budget|dollar_format }}</td>
          <td>{{ savings_data.avg_per_month|dollar_format }}</td>
          <td>{{ savings_data.budget|dollar_format }}</td>
          <td class="{% if savings_data.avg_surplus < 0 %}text-negative{% else %}text-positive{% endif %}">
            {{ savings_data.avg_surplus|dollar_format }}
          </td>
          <td class="{% if savings_data.total_surplus < 0 %}text-negative{% else %}text-positive{% endif %}">
            {{ savings_data.total_surplus|dollar_format }}
          </td>
        </tr>
      </tbody>
    </table>
  </div>
{% endblock %}

{% block scripts %}
  <script src="{% static 'tracker/vendor/chart.umd.min.js' %}"></script>
  <script>
    const savingsData = {{ savings_chart_data|safe }};
    const categoryPieData = {{ category_pie_data|safe }};
    document.querySelectorAll('.clickable-row').forEach(row => {
      row.addEventListener('click', () => {
        window.location.href = row.dataset.href;
      });
    });

    new Chart(document.getElementById('savingsChart'), {
      type: 'bar',
      data: {
        labels: savingsData.map(e => e.month),
        datasets: [
          {
            label: 'Net Savings ($)',
            data: savingsData.map(e => e.savings),
            backgroundColor: savingsData.map(e => e.savings >= 0 ? '#28a745' : '#dc3545'),
            yAxisID: 'y',
            order: 1
          },
          {
            label: '3-Month Avg ($)',
            data: savingsData.map(e => e.running),
            type: 'line',
            borderColor: '#007bff',
            backgroundColor: 'transparent',
            borderWidth: 2,
            tension: 0.3,
            pointRadius: 3,
            pointHoverRadius: 5,
            yAxisID: 'y',
            order: 0
          }
        ]
      },
      options: {
        maintainAspectRatio: false,
        animation: {
          duration: 900,
          easing: 'easeOutCubic'
        },
        plugins: {
          title: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `$${context.raw.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
              }
            }
          },
          legend: {
            display: true
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Amount ($)'
            }
          }
        }
      }
    });

    new Chart(document.getElementById('categoryPieChart'), {
      type: 'pie',
      data: {
        labels: categoryPieData.map(e => e.label),
        datasets: [{
          data: categoryPieData.map(e => e.total),
          backgroundColor: categoryPieData.map((_, idx) => `hsl(${idx * 35}, 65%, 65%)`)
        }]
      },
      options: {
        maintainAspectRatio: false,
        animation: {
          duration: 900,
          easing: 'easeOutCubic'
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                const value = context.raw || 0;
                const label = context.label || '';
                return `${label}: $${value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
              }
            }
          }
        },
        onClick: (evt, elements) => {
          if (!elements.length) return;
          const idx = elements[0].index;
          const slice = categoryPieData[idx];
          if (!slice.category_id) return;
          window.location.href = `/category_year/?category=${slice.category_id}&year={{ year }}`;
        }
      }
    });
  </script>
{% endblock %}
