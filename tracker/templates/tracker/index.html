{% extends "tracker/base.html" %}
{% load static %}
{% load humanize %}
{% load number_formatting %}

{% block title %}Budget Tracker{% endblock %}

{% block content %}
  <div class="section-actions">
    <h2 class="mb-0">Recent Transactions</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTransactionModal">Add Transaction</button>
  </div>

  <div class="card-panel">
    <h4 class="mb-3">Transactions</h4>
    <div class="table-responsive">
      <form method="get" class="row g-2 mb-3 align-items-end filter-form">
        <div class="col-auto">
          <label for="category" class="form-label mb-0">Category</label>
          <select name="category" id="category" class="form-select">
            <option value="">All</option>
            {% for category in categories %}
              <option value="{{ category.id }}" {% if category.id|stringformat:"s" == selected_category %}selected{% endif %}>{{ category.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-auto">
          <label for="source" class="form-label mb-0">Source</label>
          <select name="source" id="source" class="form-select">
            <option value="">All</option>
            {% for source in sources %}
              <option value="{{ source.id }}" {% if source.id|stringformat:"s" == selected_source %}selected{% endif %}>{{ source.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-auto">
          <label for="start_date" class="form-label mb-0">Start Date</label>
          <input type="date" name="start_date" id="start_date" class="form-control" value="{{ start_date }}">
        </div>

        <div class="col-auto">
          <label for="end_date" class="form-label mb-0">End Date</label>
          <input type="date" name="end_date" id="end_date" class="form-control" value="{{ end_date }}">
        </div>

        <div class="col-auto">
          <button type="submit" class="btn btn-primary">Apply</button>
        </div>

        {% if selected_category or selected_source or start_date or end_date %}
          <div class="col-auto">
            <a href="?" class="btn btn-outline-secondary">Reset</a>
          </div>
        {% endif %}
      </form>

      {% if transactions %}
        <table class="table table-striped table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Description</th>
              <th>Amount</th>
              <th>Date</th>
              <th>Category</th>
              <th>Source</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for transaction in transactions %}
              <tr>
                <td>{{ transaction.description }}</td>
                <td class="{% if transaction.amount < 0 %}text-negative{% else %}text-neutral{% endif %}">
                  {{ transaction.amount|dollar_format }}
                </td>
                <td>{{ transaction.date }}</td>
                <td>{{ transaction.category.name }}</td>
                <td>{{ transaction.source.name }}</td>
                <td>
                  <button class="btn btn-sm btn-warning edit-transaction-btn" data-bs-toggle="modal" data-bs-target="#editTransactionModal"
                    data-id="{{ transaction.id }}"
                    data-description="{{ transaction.description }}"
                    data-amount="{{ transaction.amount }}"
                    data-date="{{ transaction.date }}"
                    data-category="{{ transaction.category.id }}"
                    data-source="{{ transaction.source.id }}">
                    Edit
                  </button>
                  <button class="btn btn-sm btn-danger delete-btn" data-url="{% url 'delete_transaction' transaction.id %}" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal">
                    Delete
                  </button>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        <nav aria-label="Page navigation" class="mt-3">
          <ul class="pagination justify-content-center">
            {% if transactions.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page={{ transactions.previous_page_number }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_source %}&source={{ selected_source }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}">Previous</a>
              </li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Previous</span></li>
            {% endif %}

            {% if transactions.number > 3 %}
              <li class="page-item"><a class="page-link" href="?page=1{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_source %}&source={{ selected_source }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}">1</a></li>
              {% if transactions.number > 4 %}
                <li class="page-item disabled"><span class="page-link">…</span></li>
              {% endif %}
            {% endif %}

            {% for num in transactions.paginator.page_range %}
              {% if num >= transactions.number|add:'-2' and num <= transactions.number|add:'2' %}
                {% if transactions.number == num %}
                  <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% else %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_source %}&source={{ selected_source }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}">
                      {{ num }}
                    </a>
                  </li>
                {% endif %}
              {% endif %}
            {% endfor %}

            {% if transactions.number < transactions.paginator.num_pages|add:'-2' %}
              {% if transactions.number < transactions.paginator.num_pages|add:'-3' %}
                <li class="page-item disabled"><span class="page-link">…</span></li>
              {% endif %}
              <li class="page-item">
                <a class="page-link" href="?page={{ transactions.paginator.num_pages }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_source %}&source={{ selected_source }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}">
                  {{ transactions.paginator.num_pages }}
                </a>
              </li>
            {% endif %}

            {% if transactions.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ transactions.next_page_number }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_source %}&source={{ selected_source }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}">Next</a>
              </li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Next</span></li>
            {% endif %}
          </ul>
        </nav>
      {% else %}
        <p class="table-note">No transactions to show.</p>
      {% endif %}
    </div>
  </div>

  {% include './modals/add_transaction.html' %}
  {% include './modals/edit_transaction.html' %}
  {% include './modals/confirm_delete.html' %}
{% endblock %}

{% block scripts %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const editButtons = document.querySelectorAll('.edit-transaction-btn');
      const form = document.getElementById('editTransactionForm');

      const description = document.getElementById('editDescription');
      const amount = document.getElementById('editAmount');
      const date = document.getElementById('editDate');
      const category = document.getElementById('editCategory');
      const source = document.getElementById('editSource');

      editButtons.forEach((button) => {
        button.addEventListener('click', () => {
          const id = button.getAttribute('data-id');
          form.action = `{% url 'edit_transaction' 0 %}`.replace(/0/, id);
          const date_new = new Date(button.getAttribute('data-date'));
          const formatted = date_new.toISOString().split('T')[0];

          description.value = button.getAttribute('data-description');
          amount.value = button.getAttribute('data-amount');
          date.value = formatted;
          category.value = button.getAttribute('data-category');
          source.value = button.getAttribute('data-source');
        });
      });
    });
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const deleteButtons = document.querySelectorAll('.delete-btn');
      const deleteForm = document.getElementById('confirmDeleteForm');

      deleteButtons.forEach((button) => {
        button.addEventListener('click', () => {
          const url = button.getAttribute('data-url');
          deleteForm.action = url;
        });
      });
    });
  </script>
{% endblock %}
