{% extends "tracker/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Category by Year{% endblock %}

{% block content %}
  <div class="section-header">
    <h2>Category Spend by Month</h2>
    <p class="muted-note">Select a category to see how it trends through the year.</p>
  </div>

  <form method="get" class="filters">
    <select name="category" onchange="this.form.submit()">
      {% for category in categories %}
        <option value="{{ category.id }}" {% if category.id == selected_category_id %}selected{% endif %}>
          {{ category.name }}
        </option>
      {% endfor %}
    </select>
    <select name="year" onchange="this.form.submit()">
      {% for y in years %}
        <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
      {% endfor %}
    </select>
  </form>

  <div class="chart-card">
    {% if selected_category %}
      <canvas id="categoryChart"></canvas>
      <div class="center-text fw-semibold mt-3">
        {{ selected_category.name }} total for {{ year }}:
        ${{ total_for_year|floatformat:2|intcomma }}
        &nbsp;â€¢&nbsp;
        Monthly average: ${{ average_per_month|floatformat:2|intcomma }}
      </div>
    {% else %}
      <p class="center-text muted-note">Choose a category to view the chart.</p>
    {% endif %}
  </div>
{% endblock %}

{% block scripts %}
  <script src="{% static 'tracker/vendor/chart.umd.min.js' %}"></script>
  <script>
    const monthLabels = {{ month_labels|safe }};
    const monthlyTotals = {{ monthly_totals|safe }};
    const selectedYear = {{ year }};
    const selectedCategoryId = {{ selected_category_id|default:"null" }};

    {% if selected_category %}
    const categoryCtx = document.getElementById('categoryChart');
    const riseFromZero = (ctx) => ctx.chart.scales.y.getPixelForValue(0);
    const barDelay = (ctx) => {
      if (ctx.type !== 'data') return 150;
      return 150 + ctx.dataIndex * 60;
    };
    const barInteraction = { mode: 'index', intersect: false };
    if (window.Chart) {
      if (Chart.overrides) {
        Chart.overrides.bar = Chart.overrides.bar || {};
        Chart.overrides.bar.interaction = barInteraction;
        Chart.overrides.bar.hover = barInteraction;
      }
      if (Chart.defaults && typeof Chart.defaults.set === 'function') {
        Chart.defaults.set('bar', {
          interaction: barInteraction,
          hover: barInteraction
        });
      }
    }

    new Chart(categoryCtx, {
      type: 'bar',
      data: {
        labels: monthLabels,
        datasets: [{
          label: '{{ selected_category.name|escapejs }}',
          data: monthlyTotals,
          backgroundColor: monthLabels.map((_, idx) => `hsl(${idx * 30}, 70%, 60%)`),
          borderRadius: 6,
        }]
      },
      options: {
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Monthly Totals',
            padding: {
              bottom: 12
            }
          },
          tooltip: {
            callbacks: {
              label: (ctx) => `$${Number(ctx.raw || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`
            }
          },
          legend: { display: false }
        },
        animation: {
          duration: 900,
          easing: 'easeOutCubic',
          delay: barDelay
        },
        animations: {
          y: {
            from: riseFromZero,
            duration: 900,
            easing: 'easeOutCubic'
          }
        },
        scales: {
          x: { grid: { display: false } },
          y: {
            beginAtZero: true,
            title: { display: true, text: 'Amount ($)' }
          }
        },
        onClick: (evt, elements) => {
          if (!elements.length || selectedCategoryId === null) return;
          const barIndex = elements[0].index;
          const month = barIndex + 1;
          const start = `${selectedYear}-${String(month).padStart(2, '0')}-01`;
          const lastDay = new Date(selectedYear, month, 0).getDate();
          const end = `${selectedYear}-${String(month).padStart(2, '0')}-${String(lastDay).padStart(2, '0')}`;
          const url = `/?category=${selectedCategoryId}&start_date=${start}&end_date=${end}`;
          window.location.href = url;
        }
      }
    });
    {% endif %}
  </script>
{% endblock %}
