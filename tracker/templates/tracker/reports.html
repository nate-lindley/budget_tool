{% extends "tracker/base.html" %}
{% load static %}
{% load humanize %}
{% load number_formatting %}

{% block title %}Monthly Reports{% endblock %}

{% block content %}
  <div class="section-header">
    <h2>Monthly Spending Report</h2>
    <p>Select a month and year to see a detailed breakdown of your spending.</p>
  </div>

  <form method="get" class="filters">
    <select name="month" onchange="this.form.submit()">
      {% for num, name in months %}
        <option value="{{ num }}" {% if num == selected_month %}selected{% endif %}>{{ name }}</option>
      {% endfor %}
    </select>
    <select name="year" onchange="this.form.submit()">
      {% for y in years %}
        <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
      {% endfor %}
    </select>
  </form>

  <div class="charts-container">
    <div class="chart-card">
      <canvas id="pieChart"></canvas>
    </div>
    <div class="chart-card">
      <canvas id="lineChart"></canvas>
    </div>
    <div class="chart-card">
      <canvas id="barChart"></canvas>
    </div>
  </div>

  <table class="data-table category-table" id="reportTable">
    <thead>
      <tr>
          <th data-column="0" data-label="Category" onclick="sortTable(0)">Category</th>
          <th data-column="1" data-label="Total Spent" onclick="sortTable(1)">Total</th>
          <th data-column="2" data-label="Budget" onclick="sortTable(2)">Budget</th>
          <th data-column="3" data-label="Surplus / Deficit" onclick="sortTable(3)">Surplus / Deficit</th>
        </tr>
    </thead>
    <tbody>
      {% for entry in table_data %}
        <tr>
          <td>{{ entry.category__name }}</td>
          <td>{{ entry.total|dollar_format }}</td>
          <td class="{% if entry.is_budget_negative %}text-negative{% endif %}">
              {{ entry.budget|dollar_format }}
            </td>
            <td class="{% if entry.is_surplus_negative %}text-negative{% else %}text-positive{% endif %}">
              {{ entry.surplus|dollar_format }}
            </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% endblock %}

{% block scripts %}
  <script src="{% static 'tracker/vendor/chart.umd.min.js' %}"></script>
  <script>
      const baseAnimation = {
        duration: 1100,
        easing: 'easeOutCubic'
      };
      const staggerDelay = (ctx) => ctx.type === 'data' ? ctx.dataIndex * 70 : 0;
      const riseFromZero = (ctx) => ctx.chart?.scales?.y?.getPixelForValue ? ctx.chart.scales.y.getPixelForValue(0) : 0;

      function sortTable(columnIndex) {
        const table = document.getElementById("reportTable");
        const tbody = table.tBodies[0];
        const rows = Array.from(tbody.rows);
        const isNumber = columnIndex !== 0;
      
        const ths = table.querySelectorAll("th");
        const currentIsAsc = table.dataset.sortCol == columnIndex && table.dataset.sortDir === "asc";
        const direction = currentIsAsc ? -1 : 1;
      
        ths.forEach(th => th.classList.remove("table-active"));
        ths[columnIndex].classList.add("table-active");
      
        rows.sort((a, b) => {
          const aText = a.cells[columnIndex].innerText.trim().replace(/[$,]/g, '');
          const bText = b.cells[columnIndex].innerText.trim().replace(/[$,]/g, '');
      
          let aValue = aText;
          let bValue = bText;
      
          if (isNumber) {
            aValue = parseFloat(aText) || 0;
            bValue = parseFloat(bText) || 0;
          }
      
          if (aValue < bValue) return -1 * direction;
          if (aValue > bValue) return 1 * direction;
          return 0;
        });
      
        rows.forEach(row => tbody.appendChild(row));
      
        table.dataset.sortCol = columnIndex;
        table.dataset.sortDir = direction === 1 ? "asc" : "desc";
      }
      
      const pieData = {{ pie_data|safe }}.slice().sort((a, b) => (b.total || 0) - (a.total || 0));
      const lineData = {{ line_data|safe }};
      const categories = pieData.map(e => e.category__name);
      const totals = pieData.map(e => e.total);
      const spendVsIncomeLabels = ['Income', 'Spend'];
      const spendVsIncomeData = [{{ income|default:0 }}, {{ total_spent|default:0 }}];

      const pieCtx = document.getElementById('pieChart').getContext('2d');
      const lineCtx = document.getElementById('lineChart').getContext('2d');
      const barCtx = document.getElementById('barChart').getContext('2d');
      const barInteraction = { mode: 'index', intersect: false };
      if (window.Chart) {
        if (Chart.overrides) {
          Chart.overrides.bar = Chart.overrides.bar || {};
          Chart.overrides.bar.interaction = barInteraction;
          Chart.overrides.bar.hover = barInteraction;
        }
        if (Chart.defaults && typeof Chart.defaults.set === 'function') {
          Chart.defaults.set('bar', {
            interaction: barInteraction,
            hover: barInteraction
          });
        }
      }

      new Chart(pieCtx, {
        type: 'pie',
        data: {
          labels: pieData.map(e => e.category__name),
          datasets: [{
            data: pieData.map(e => e.total),
            backgroundColor: pieData.map((_, idx) => `hsl(${idx * 35}, 65%, 65%)`)
          }]
        },
        options: {
          maintainAspectRatio: false,
          animation: {
            duration: 900,
            easing: 'easeOutCubic',
            animateRotate: true,
            animateScale: true
          },
          plugins: {
            legend: { display: false },
            title: {
              display: true,
              text: 'Spend by Category'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  return `${label}: $${value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                }
              }
            }
          }
        }
      });

      new Chart(lineCtx, {
        type: 'line',
        data: {
          labels: lineData.map(e => e.date),
          datasets: [{
            label: 'Cumulative Spend',
            data: lineData.map(e => e.cumulative),
            borderColor: '#0d6efd',
            backgroundColor: 'transparent',
            tension: 0.25
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            title: {
              display: true,
            text: 'Cumulative Spend Over Month'
            }
          },
          animation: baseAnimation,
          animations: {
            y: {
              from: riseFromZero,
              delay: staggerDelay,
              duration: baseAnimation.duration
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Amount ($)' }
            }
          }
        }
      });

      new Chart(barCtx, {
        type: 'bar',
        data: {
          labels: spendVsIncomeLabels,
          datasets: [
            {
              label: 'Amount',
              data: spendVsIncomeData,
              backgroundColor: ['#198754', '#0d6efd'],
              borderRadius: 6
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
            ,title: {
              display: true,
              text: 'Income vs Spend'
            }
          },
          animation: {
            ...baseAnimation,
            delay: staggerDelay
          },
          animations: {
            y: {
              from: riseFromZero,
              delay: staggerDelay,
              duration: baseAnimation.duration
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Amount ($)' }
            }
          }
        }
      });
  </script>
{% endblock %}
